find_runtime() {
    if [ $ngx_found = yes ]; then
        return
    fi

    ngx_feature="$NGX_WASM_RUNTIME library"
    ngx_feature_path=
    ngx_feature_libs=

    if [ -n "$1" ]; then
        ngx_feature="$ngx_feature, -I $1"
        ngx_feature_path="$1"
    fi
    if [ -n "$2" ]; then
        ngx_feature="$ngx_feature, -L $2 -l$NGX_WASM_RUNTIME"
        ngx_feature_libs="-L $2 -l$NGX_WASM_RUNTIME"
    fi
    if [ -n "$3" ]; then
        ngx_feature="$ngx_feature ($3)"
        ngx_feature_libs="$3"
    fi

    ngx_feature_run=no
    ngx_feature_test=

    . auto/feature
}

NGX_WASM_RUNTIME="${NGX_WASM_RUNTIME:-wasmtime}"

ngx_found=no

case $NGX_WASM_RUNTIME in
    wasmtime)
        ngx_wasm_runtime_inc="$ngx_addon_dir/src/wasm/wasmtime"

        ngx_feature_name="NGX_WASM_HAVE_WASMTIME"
        ngx_feature_incs="#include <wasm.h>
                          #include <wasmtime.h>"
        ;;
    WAVM)
        ngx_wasm_runtime_inc="$ngx_addon_dir/src/wasm/wavm"

        ngx_feature_name="NGX_WASM_HAVE_WAVM"
        ngx_feature_incs="#include <wavm-c.h>"
        ;;
    *)
        echo "$0: error: unsupported wasm runtime \"$NGX_WASM_RUNTIME\"."
        echo "Supported runtime: wasmtime, WAVM."
        echo
        exit 1
esac

find_runtime "$NGX_WASM_RUNTIME_INC" "$NGX_WASM_RUNTIME_LIB" "$NGX_WASM_RUNTIME_LD_OPT"
find_runtime "/usr/local/opt/include" "/usr/local/opt/lib"
find_runtime "/usr/local/include"     "/usr/local/lib"

if [ $ngx_found = no ]; then
    cat << END
$0: error: $ngx_module_name could not find the $NGX_WASM_RUNTIME library.
You can set the \$NGX_WASM_RUNTIME_INC and \$NGX_WASM_RUNTIME_LIB environment variables."

END
    echo
    exit 1
fi

have=NGX_WASM_RUNTIME value="\"$NGX_WASM_RUNTIME\"" . auto/define

###############################################################################

ngx_module_type=CORE
ngx_module_name=ngx_wasm_module
ngx_module_incs="$ngx_feature_path \
                 $ngx_addon_dir/src/wasm \
                 $ngx_addon_dir/src/wasm/vm \
                 $ngx_addon_dir/src/common \
                 $ngx_wasm_runtime_inc"
ngx_module_libs="$ngx_feature_libs"
ngx_module_deps="$ngx_addon_dir/src/wasm/ngx_wasm.h \
                 $ngx_addon_dir/src/wasm/vm/ngx_wavm.h \
                 $ngx_addon_dir/src/wasm/vm/ngx_wavm_hfuncs.h \
                 $ngx_addon_dir/src/wasm/ngx_wasm_ops.h \
                 $ngx_wasm_runtime_inc/ngx_wrt.h"
ngx_module_srcs="$ngx_addon_dir/src/wasm/ngx_wasm.c \
                 $ngx_addon_dir/src/wasm/vm/ngx_wavm.c \
                 $ngx_addon_dir/src/wasm/vm/ngx_wavm_hfuncs.c \
                 $ngx_addon_dir/src/wasm/ngx_wasm_ops.c \
                 $ngx_addon_dir/src/wasm/ngx_wasm_util.c \
                 $ngx_wasm_runtime_inc/ngx_wrt.c"
ngx_module_link=ADDON

. auto/module

###############################################################################

ngx_module_type=WASM
ngx_module_name=ngx_wasm_core_module
ngx_module_incs=
ngx_module_libs=
ngx_module_deps=
ngx_module_srcs="$ngx_addon_dir/src/wasm/ngx_wasm_core_module.c \
                 $ngx_addon_dir/src/wasm/ngx_wasm_core_hfuncs.c"
ngx_module_link=ADDON

. auto/module

###############################################################################

ngx_module_type=WASM
ngx_module_name=ngx_http_wasm_hfuncs_module
ngx_module_incs=
ngx_module_libs=
ngx_module_deps=
ngx_module_srcs="$ngx_addon_dir/src/http/ngx_http_wasm_hfuncs_module.c"
ngx_module_link=ADDON

. auto/module

###############################################################################

#ngx_module_type=WASM
#ngx_module_name=ngx_http_proxy_wasm_hfuncs_module
#ngx_module_incs=
#ngx_module_libs=
#ngx_module_deps=
#ngx_module_srcs="$ngx_addon_dir/src/http/proxy_wasm/ngx_http_proxy_wasm_hfuncs_module.c"
#ngx_module_link=ADDON
#
#. auto/module

###############################################################################

ngx_module_type=HTTP
ngx_module_name=ngx_http_wasm_module
ngx_module_incs="$ngx_addon_dir/src/http"
ngx_module_libs=
ngx_module_deps="$ngx_addon_dir/src/http/ngx_http_wasm.h"
ngx_module_srcs="$ngx_addon_dir/src/http/ngx_http_wasm_module.c \
                 $ngx_addon_dir/src/http/ngx_http_wasm_util.c"
ngx_module_link=ADDON

. auto/module

###############################################################################

#ngx_module_type=HTTP
#ngx_module_name=ngx_http_proxy_wasm_module
#ngx_module_incs="$ngx_addon_dir/src/http"
#ngx_module_libs=
#ngx_module_deps="$ngx_addon_dir/src/http/ngx_http_wasm.h"
#ngx_module_srcs="$ngx_addon_dir/src/http/proxy_wasm/ngx_http_proxy_wasm_module.c \
#                 $ngx_addon_dir/src/http/ngx_http_wasm_util.c"
#ngx_module_link=ADDON
#
#. auto/module

###############################################################################

# bypass auto/make which does not recognize WASM_INCS and WASM_MODULES
CORE_INCS="$CORE_INCS $WASM_INCS"
CORE_MODULES="$CORE_MODULES $WASM_MODULES"

# vim:ft=sh ts=4 sts=4 sw=4:
